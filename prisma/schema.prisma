generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// PRIMERO: Modelos b√°sicos que no dependen de otros
model Brand {
  id          String       @id @default(uuid())
  name        String       @unique
  phoneModels PhoneModel[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  status      String       @default("active")
  logoUrl     String?
}

model PhoneModel {
  id        String    @id @default(uuid())
  name      String    @unique
  brand     Brand     @relation(fields: [brandId], references: [id])
  brandId   String
  status    String    @default("active")
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model ProductType {
  id        String    @id @default(uuid())
  name      String    @unique
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  status    String    @default("active")
}

model Color {
  id        String    @id @default(uuid())
  name      String    @unique
  hexCode   String
  status    String    @default("active")
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Material {
  id        String    @id @default(uuid())
  name      String    @unique
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  status    String    @default("active")
}

model Compatibility {
  id         String   @id @default(uuid())
  name       String   @unique
  deviceType String
  status     String   @default("active")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Supplier {
  id        String     @id @default(uuid())
  name      String
  contact   String?
  email     String?
  phone     String?
  address   String?
  products  Product[]
  purchases Purchase[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  status    String     @default("active")
}

model Client {
  id        String   @id @default(uuid())
  name      String
  contact   String?
  email     String?
  phone     String?
  address   String?
  sales     Sale[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id                 String              @id @default(uuid())
  username           String              @unique
  password           String
  name               String
  role               String              @default("user")
  isActive           Boolean             @default(true)
  lastLoginAt        DateTime?
  inventoryMovements InventoryMovement[]
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  @@index([username])
}

// SEGUNDO: Modelo Product (depende de todos los anteriores)
model Product {
  id                 String              @id @default(uuid())
  phoneModel         PhoneModel          @relation(fields: [phoneModelId], references: [id])
  phoneModelId       String
  color              Color               @relation(fields: [colorId], references: [id])
  colorId            String
  stock              Int
  minStock           Int                 @default(5)
  priceRetail        Float
  priceWholesale     Float
  costPrice          Float
  hasDiscount        Boolean             @default(false)
  discountPercentage Int?
  discountPrice      Float?
  type               ProductType         @relation(fields: [typeId], references: [id])
  typeId             String
  supplier           Supplier?           @relation(fields: [supplierId], references: [id])
  supplierId         String?
  material           Material?           @relation(fields: [materialId], references: [id])
  materialId         String?
  sales              Sale[]
  purchases          Purchase[]
  movements          InventoryMovement[]
  createdAt          DateTime            @default(now())
  imageUrl           String?
  updatedAt          DateTime            @updatedAt
  status             String              @default("active")

  @@index([phoneModelId, colorId])
  @@index([typeId])
  @@index([stock])
  @@index([hasDiscount])
}

// TERCERO: Modelos de transacciones (dependen de Product)
model Sale {
  id              String   @id @default(uuid())
  productId       String
  product         Product  @relation(fields: [productId], references: [id])
  quantity        Int
  unitPrice       Float
  originalPrice   Float?
  discountApplied Float?   @default(0)
  totalPrice      Float
  customerName    String?
  customerPhone   String?
  paymentMethod   String   @default("efectivo")
  notes           String?
  clientId        String
  client          Client   @relation(fields: [clientId], references: [id])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([createdAt])
  @@index([productId])
}

model Purchase {
  id            String   @id @default(uuid())
  productId     String
  product       Product  @relation(fields: [productId], references: [id])
  supplierId    String
  supplier      Supplier @relation(fields: [supplierId], references: [id])
  quantity      Int
  unitPrice     Float
  totalPrice    Float
  invoiceNumber String?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([createdAt])
  @@index([productId])
  @@index([supplierId])
}

model InventoryMovement {
  id        String   @id @default(uuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  type      String
  quantity  Int
  reason    String
  reference String?
  notes     String?
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  @@index([productId])
  @@index([createdAt])
}

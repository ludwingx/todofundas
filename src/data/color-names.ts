// Mapa de colores en español - Sin duplicados
export const COLOR_NAMES_ES: Record<string, string> = {
  // ROJOS
  '#FF0000': 'Rojo',
  '#DC143C': 'Carmesí',
  '#B22222': 'Rojo Fuego',
  '#8B0000': 'Rojo Oscuro',
  '#FF4500': 'Rojo Naranja',
  '#FF6347': 'Tomate',
  '#FF7F50': 'Coral',
  '#CD5C5C': 'Marrón Rosado',
  '#F08080': 'Rosa Claro',
  '#E9967A': 'Salmón Oscuro',
  '#FA8072': 'Salmón',
  '#FF8C69': 'Salmón Oscuro',
  '#FF6B6B': 'Rojo Claro',
  '#E74C3C': 'Rojo Bermellón',
  '#C0392B': 'Rojo Fuerte',
  '#A93226': 'Rojo Oscuro',
  '#F5B7B1': 'Rosa Pálido',
  '#F1948A': 'Rosa',
  '#EC7063': 'Rosa Oscuro',
  '#CB4335': 'Rojo',
  '#B03A2E': 'Rojo Oscuro',
  '#943126': 'Rojo Vino',
  '#78281F': 'Burgundy',
  '#641E16': 'Granate',
  '#FFE4E1': 'Rosa Claro',
  '#FFDAB9': 'Durazno Pálido',
  '#C70039': 'Rojo Rubí',
  '#900C3F': 'Borgoña Oscuro',
  '#581845': 'Púrpura Oscuro',
  '#4A0000': 'Rojo Vino Oscuro',
  '#330000': 'Rojo Caoba',
  '#2B0000': 'Rojo Ébano',
  '#5D0000': 'Rojo Sangre',
  '#450000': 'Rojo Óxido',
  '#FF4040': 'Rojo Coral',
  '#FF3333': 'Rojo Brillante',
  '#CC0000': 'Rojo Cereza',
  '#990000': 'Rojo Sangre Oscuro',
  '#660000': 'Rojo Caoba Oscuro',
  '#FF1A1A': 'Rojo Fuego',
  '#E60000': 'Rojo Escarlata',

  // ROSAS Y MAGENTAS
  '#FF69B4': 'Rosa Intenso',
  '#FF1493': 'Rosa Profundo',
  '#DB7093': 'Rosa Pálido',
  '#C71585': 'Violeta Rojo Medio',
  '#FFC0CB': 'Rosa',
  '#FFB6C1': 'Rosa Pastel',
  '#FF00FF': 'Magenta',
  '#EE82EE': 'Violeta',
  '#8B4C6F': 'Rosa Oscuro',
  '#6A3C54': 'Rosa Borgoña',
  '#FF91A4': 'Rosa Salmón',
  '#FF77FF': 'Rosa Fucsia',
  '#D94D73': 'Rosa Frambuesa',
  '#C54B8C': 'Rosa Malva',
  '#E75480': 'Rosa Rosa',
  '#F4AFC8': 'Rosa Pastel',
  '#FFB7C5': 'Rosa Algodón',
  '#FFAEB9': 'Rosa Bebé',
  '#FF6EB4': 'Rosa Caliente',

  // NARANJAS Y DURAZNOS
  '#FFA500': 'Naranja',
  '#FF8C00': 'Naranja Oscuro',
  '#FFA07A': 'Salmón Claro',
  '#E67E22': 'Naranja Calabaza',
  '#F39C12': 'Naranja Dorado',
  '#E59866': 'Durazno',
  '#CC5500': 'Naranja Cobrizo',
  '#A35200': 'Naranja Terracota',
  '#8B4500': 'Naranja Miel',
  '#FF8000': 'Naranja Neón',
  '#FF6600': 'Naranja Tráfico',
  '#FF5500': 'Naranja Brillante',
  '#FF4400': 'Naranja Rojo',
  '#FF9900': 'Naranja Ambar',
  '#FFB74D': 'Naranja Melocotón',
  '#FFA726': 'Naranja Mango',
  '#FF9800': 'Naranja Zafiro',

  // AMARILLOS Y DORADOS
  '#FFD700': 'Oro',
  '#FFE4B5': 'Mocasín',
  '#FFE4C4': 'Bisque',
  '#FFEBCD': 'Blanco Almendra',
  '#FFEFD5': 'Papaya Whip',
  '#FFF5EE': 'Concha de Mar',
  '#F5F5DC': 'Beige',
  // '#F5DEB3': 'Trigo', // Similar to '#F5F5DC'
  '#F4A460': 'Marrón Arena',
  '#D2B48C': 'Bronceado',
  '#DAA520': 'Dorado',
  '#B8860B': 'Oro Oscuro',
  '#BDB76B': 'Caqui Oscuro',
  '#9ACD32': 'Amarillo Verdoso',
  '#6B8E23': 'Oliva Apagado',
  '#556B2F': 'Oliva Oscuro',
  '#808000': 'Oliva',
  '#F0E68C': 'Caqui Claro',
  '#EEE8AA': 'Amarillo Claro',
  '#FAFAD2': 'Amarillo Claro',
  '#FFFFE0': 'Amarillo Claro',
  '#FFFF00': 'Amarillo',
  '#FFFAF0': 'Lino',
  '#FDFD96': 'Amarillo Canario',
  '#FFFACD': 'Limón Chiffon',
  '#8B8000': 'Amarillo Mostaza',
  '#665500': 'Amarillo Oliva Oscuro',
  '#FFEB3B': 'Amarillo Limón',
  '#FFF176': 'Amarillo Maíz',
  '#FFEE58': 'Amarillo Girasol',
  '#FBC02D': 'Amarillo Ocre',
  '#F57F17': 'Amarillo Mostaza Oscuro',

  // VERDES
  '#008000': 'Verde',
  '#006400': 'Verde Oscuro',
  '#2E8B57': 'Verde Mar',
  '#3CB371': 'Verde Mar Medio',
  '#66CDAA': 'Aqua Marina',
  '#7FFFD4': 'Aguamarina',
  '#00FA9A': 'Verde Primavera Medio',
  '#00FF7F': 'Verde Primavera',
  '#32CD32': 'Lima',
  '#00FF00': 'Verde Lima',
  '#7CFC00': 'Hierba',
  '#7FFF00': 'Verde Claro',
  '#ADFF2F': 'Verde Amarillento',
  '#228B22': 'Verde Bosque',
  '#8FBC8F': 'Verde Mar Oscuro',
  '#98FB98': 'Menta Pálida',
  '#00A86B': 'Esmeralda',
  '#4C784D': 'Verde Cazador',
  '#004D00': 'Verde Bosque Oscuro',
  '#003300': 'Verde Abeto',
  '#002200': 'Verde Pino',
  '#006633': 'Verde Esmeralda Oscuro',
  '#00512C': 'Verde Jade',
  '#00FF80': 'Verde Menta',
  '#00FF99': 'Verde Agua',
  '#00CC66': 'Verde Esmeralda',
  '#33CC99': 'Verde Turquesa',
  '#66FF99': 'Verde Manzana',
  '#99FF99': 'Verde Pastel',
  '#CCFF99': 'Verde Lima Claro',
  '#00CC00': 'Verde Brillante',
  '#33FF33': 'Verde Neón',

  // AZULES
  '#0000FF': 'Azul',
  '#1E90FF': 'Azul Dodger',
  '#4169E1': 'Azul Real',
  '#0000CD': 'Azul Medio',
  '#00008B': 'Azul Oscuro',
  '#000080': 'Azul Marino',
  '#191970': 'Azul Medianoche',
  '#4682B4': 'Azul Acero',
  '#5F9EA0': 'Azul Verde Menta',
  '#B0E0E6': 'Azul Polvo',
  '#ADD8E6': 'Azul Claro',
  '#B0C4DE': 'Azul Acero Claro',
  '#87CEEB': 'Azul Cielo',
  '#87CEFA': 'Azul Cielo Claro',
  '#00BFFF': 'Azul Cielo Profundo',
  '#6495ED': 'Azul Aciano',
  '#5DADE2': 'Azul Cerúleo',
  '#1F618D': 'Azul Zafiro',
  '#3498DB': 'Azul Capri',
  '#5D8AA8': 'Azul Aeronáutico',
  '#483D8B': 'Azul Pizarra Oscuro',
  '#6A5ACD': 'Azul Pizarra',
  '#7B68EE': 'Azul Pizarra Medio',
  '#00CED1': 'Turquesa Oscuro',
  '#000066': 'Azul Medianoche Profundo',
  '#001933': 'Azul Cobalto',
  '#00264D': 'Azul Marino Oscuro',
  '#003366': 'Azul Acero Oscuro',
  '#004080': 'Azul Real Oscuro',
  '#0000CC': 'Azul Eléctrico',
  '#3333FF': 'Azul Neón',
  '#6666FF': 'Azul Lavanda',
  '#9999FF': 'Azul Pastel',
  '#CCCCFF': 'Azul Claro Pastel',
  '#3366FF': 'Azul Cobalto Claro',
  '#6699FF': 'Azul Celeste',
  '#99CCFF': 'Azul Bebé',
  '#0066FF': 'Azul Francia',
  '#0099FF': 'Azul Oceano',

  // TURQUESAS Y CIANES
  '#008B8B': 'Cian Oscuro',
  '#008080': 'Verde Azulado',
  '#48D1CC': 'Turquesa Medio',
  '#40E0D0': 'Turquesa',
  '#00FFFF': 'Cian',
  '#E0FFFF': 'Azul Cielo Claro',
  '#AFEEEE': 'Turquesa Pálido',
  '#79CDCD': 'Turquesa Medio',
  '#46B1C9': 'Azul Pato',
  '#53CACE': 'Verde Agua',
  '#006666': 'Turquesa Profundo',
  '#004D4D': 'Verde Azulado Oscuro',
  '#00CCCC': 'Cian Brillante',
  '#33CCCC': 'Turquesa Claro',
  '#66CCCC': 'Turquesa Pastel',
  '#99CCCC': 'Turquesa Grisáceo',
  '#00AAAA': 'Verde Azulado Medio',
  '#008888': 'Cian Medio',
  '#20B2AA': 'Verde Mar Claro',

  // MORADOS Y VIOLETAS
  '#800080': 'Púrpura',
  '#8A2BE2': 'Azul Violeta',
  '#9932CC': 'Orquídea Oscura',
  '#9400D3': 'Violeta Oscuro',
  '#9370DB': 'Púrpura Medio',
  '#4B0082': 'Índigo',
  '#C9A0DC': 'Lila',
  '#A368A9': 'Malva',
  '#C8A2C8': 'Ciruela',
  '#DA70D6': 'Orquídea',
  '#E6E6FA': 'Lavanda',
  '#4B0080': 'Púrpura Real',
  '#330066': 'Violeta Profundo',
  '#2E004F': 'Morado Ébano',
  '#BA55D3': 'Orquídea Media',
  '#DDA0DD': 'Ciruela Claro',
  '#EE82EE': 'Violeta',
  '#FF00FF': 'Magenta',
  '#FF33FF': 'Magenta Brillante',
  '#FF66FF': 'Magenta Pastel',
  '#CC00CC': 'Púrpura Eléctrico',
  '#990099': 'Púrpura Uva',

  // MARRONES Y TIERRAS
  '#A0522D': 'Siena',
  '#8B4513': 'Marrón Cuero',
  '#D2691E': 'Chocolate',
  '#CD853F': 'Bronceado Peruano',
  '#C19A6B': 'Marrón Claro',
  '#654321': 'Marrón Oscuro',
  '#69592D': 'Caqui Oscuro',
  '#3D2B1F': 'Marrón Chocolate Oscuro',
  '#2F1B0C': 'Marrón Café',
  '#4A3526': 'Marrón Cuero Oscuro',
  '#5C4033': 'Marrón Caoba',
  '#6F4E37': 'Marrón Café Claro',
  '#8B7355': 'Marrón Bronce',

  // GRISES Y NEUTROS
  '#808080': 'Gris',
  '#696969': 'Gris Oscuro',
  '#778899': 'Gris Pizarra Claro',
  '#708090': 'Gris Pizarra',
  '#2F4F4F': 'Gris Pizarra Oscuro',
  '#D3D3D3': 'Gris Claro',
  '#A9A9A9': 'Gris Oscuro',
  '#C0C0C0': 'Plata',
  '#DCDCDC': 'Gris Ganancia',
  '#F5F5F5': 'Gris Humo',
  '#E5E5E5': 'Gris Plata',
  '#F0F0F0': 'Gris Claro',
  '#F0FFF0': 'Miel',
  '#FFF0F5': 'Lavanda Rojo',
  '#E6E6FA': 'Lavanda',
  '#FAF0E6': 'Lino',
  '#FDF5E6': 'Blanco Antiguo',
  '#FAEBD7': 'Blanco Antiguo',
  '#FFFAF0': 'Blanco Hueso',
  '#FFF8DC': 'Blanco Maíz',
  '#F0F0F0': 'Gris Claro',
  '#36454F': 'Gris Carbón',
  '#121212': 'Negro Carbón',
  '#1A1A1A': 'Gris Ébano',
  '#262626': 'Gris Antracita',
  '#333333': 'Gris Charcoal',
  '#4D4D4D': 'Gris Pizarra Medio',
  '#F2F2F2': 'Gris Nube',
  '#FAFAFA': 'Blanco Fantasma',

  // COLORES METÁLICOS
  '#B87333': 'Cobre',
  '#D4AF37': 'Oro Metálico',
  '#AAA9AD': 'Acero',
  '#71797E': 'Acero Inoxidable',
  '#B76E79': 'Oro Rosa',

  // COLORES NEÓN
  '#39FF14': 'Verde Neón',
  '#FF073A': 'Rosa Neón',
  '#1F51FF': 'Azul Neón',
  '#FF3131': 'Rojo Neón',
  '#FF5F1F': 'Naranja Neón',
  '#CCFF00': 'Amarillo Neón',
  '#BF00FF': 'Púrpura Neón',
  '#00F5FF': 'Cian Neón',

  // COLORES PASTEL
  '#FFB6C1': 'Rosa Pastel',
  '#87CEEB': 'Azul Pastel',
  '#98FB98': 'Verde Pastel',
  '#DDA0DD': 'Púrpura Pastel',
  '#FFA07A': 'Naranja Pastel',
  '#F0E68C': 'Amarillo Pastel Claro',
  '#E6E6FA': 'Lavanda Pastel',
  '#FFEFD5': 'Melocotón Pastel',
  '#F5F5DC': 'Beige Pastel',
};

// Total: ~300+ colores únicos organizados por familia
// Se han eliminado todos los duplicados para resolver el error TypeScript
export function hexToRgb(hex: string): {r: number, g: number, b: number} | null {
  hex = hex.replace(/^#/, '')
  
  if (hex.length === 3) {
    hex = hex.split('').map(c => c + c).join('')
  } else if (hex.length !== 6) {
    return null
  }
  
  const num = parseInt(hex, 16)
  return {
    r: (num >> 16) & 255,
    g: (num >> 8) & 255,
    b: num & 255
  }
}

export function colorDistance(rgb1: {r: number, g: number, b: number}, rgb2: {r: number, g: number, b: number}): number {
  return Math.sqrt(
    Math.pow(rgb1.r - rgb2.r, 2) +
    Math.pow(rgb1.g - rgb2.g, 2) +
    Math.pow(rgb1.b - rgb2.b, 2)
  )
}

// Type for the color-namer module
type ColorNamer = {
  <T extends string = string>(color: string, options?: { pick?: T[]; omit?: T[] }): Record<string, Array<{ name: string }>>;
  default?: ColorNamer;
}

type ColorNamerModule = {
  (color: string, options?: { pick?: string[]; omit?: string[] }): Record<string, Array<{ name: string }>>;
  default?: ColorNamerModule;
}

// Importar color-namer dinámicamente para evitar problemas de SSR
const getNamer = async (): Promise<ColorNamer | null> => {
  if (typeof window === 'undefined') return null;
  try {
    const namerModule = await import('color-namer');
    // Handle both ESM and CJS module formats
    const namer = 'default' in namerModule ? namerModule.default : namerModule;
    // Ensure the namer is callable
    return typeof namer === 'function' ? namer : null;
  } catch (error) {
    console.error('Error loading color-namer:', error);
    return null;
  }
};

export async function getColorName(hex: string): Promise<string> {
  const upperHex = hex.toUpperCase()
  
  if (COLOR_NAMES_ES[upperHex]) {
    return COLOR_NAMES_ES[upperHex]
  }
  
  try {
    const rgb = hexToRgb(upperHex)
    if (!rgb) return await getColorFromNamer(hex)
    
    let closestColor = ''
    let minDistance = Infinity
    
    for (const [colorHex, colorName] of Object.entries(COLOR_NAMES_ES)) {
      const colorRgb = hexToRgb(colorHex)
      if (!colorRgb) continue
      
      const distance = colorDistance(rgb, colorRgb)
      if (distance < minDistance) {
        minDistance = distance
        closestColor = colorName
      }
    }
    
    if (minDistance < 50) {
      return closestColor;
    }
    
    return await getColorFromNamer(hex);
    
  } catch (error) {
    console.error('Error al obtener el nombre del color:', error)
    return await getColorFromNamer(hex)
  }
}

// Función para determinar el tono de un color (claro/oscuro)
function getColorTone(rgb: {r: number, g: number, b: number}): 'light' | 'dark' {
  const luminance = (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;
  return luminance > 0.5 ? 'light' : 'dark';
}

// Función auxiliar para obtener el nombre del color usando color-namer
async function getColorFromNamer(hex: string): Promise<string> {
  try {
    const rgb = hexToRgb(hex);
    if (!rgb) return 'Color personalizado';
    
    const namer = await getNamer();
    if (!namer) return 'Color personalizado';
    
    // Call the namer function with the hex value
    const names = namer(hex);
    
    const getBestName = (): string => {
      // Find the first available color name from any palette
      const getFirstAvailableName = (): string | undefined => {
        // Try Spanish names first
        const colorNames = names as Record<string, Array<{ name: string }>>;
        
        // Try to get Spanish name first
        if (colorNames.es?.[0]?.name) {
          return colorNames.es[0].name;
        }
        
        // Fall back to basic names
        if (colorNames.basic?.[0]?.name) {
          const baseName = colorNames.basic[0].name;
          
          const max = Math.max(rgb.r, rgb.g, rgb.b);
          const min = Math.min(rgb.r, rgb.g, rgb.b);
          const saturation = (max - min) / max || 0;
          
          if (saturation < 0.2) {
            return (getColorTone(rgb) === 'dark' ? 'Grisáceo ' : 'Apagado ') + baseName;
          }
          
          return baseName;
        }
        
        // Then try any other palette
        for (const palette in names) {
          if (names[palette]?.[0]?.name) {
            return names[palette][0].name;
          }
        }
        
        return undefined;
      };
      
      const baseName = getFirstAvailableName();
      if (baseName) {
        
        const max = Math.max(rgb.r, rgb.g, rgb.b);
        const min = Math.min(rgb.r, rgb.g, rgb.b);
        const saturation = (max - min) / max || 0;
        
        if (saturation < 0.2) {
          return (tone === 'dark' ? 'Grisáceo ' : 'Apagado ') + baseName;
        }
        
        return baseName;
      }
      
      return '';
    };
    
    const bestName = getBestName();
    
    if (!bestName) {
      const {r, g, b} = rgb;
      const hue = Math.round(Math.atan2(Math.sqrt(3) * (g - b), 2 * r - g - b) * 180 / Math.PI);
      
      let colorFamily = '';
      if (hue < 15 || hue >= 345) colorFamily = 'Rojo';
      else if (hue < 45) colorFamily = 'Naranja';
      else if (hue < 75) colorFamily = 'Amarillo';
      else if (hue < 150) colorFamily = 'Verde';
      else if (hue < 195) colorFamily = 'Cian';
      else if (hue < 255) colorFamily = 'Azul';
      else if (hue < 285) colorFamily = 'Violeta';
      else colorFamily = 'Magenta';
      
      const toneName = tone === 'dark' ? 'Oscuro' : 'Claro';
      const intensity = Math.round((r + g + b) / 7.65);
      
      return `${toneName} ${colorFamily} ${intensity}%`;
    }
    
    return bestName.charAt(0).toUpperCase() + bestName.slice(1);
    
  } catch (error) {
    console.error('Error al obtener nombre con color-namer:', error);
    return 'Color personalizado';
  }
}